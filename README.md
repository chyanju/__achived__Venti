<div align="left">
  <h2>
    <img src="./doc/icon.png" width=50>Venti - Verifying Smart Contracts via Yul
  </h2>
</div>

*<u>Note: This project is still under alpha development and it includes some temporary developing notes.</u>*

### Require

- Racket (7.0+): [https://racket-lang.org/](https://racket-lang.org/)
- Rosette (latest release): [https://github.com/emina/rosette](https://github.com/emina/rosette)
- Solc (0.7.3 recommended): [https://github.com/crytic/solc-select](https://github.com/crytic/solc-select)
- Python (3.6+): [https://www.python.org/](https://www.python.org/)
- Antlr (4.8): [https://github.com/antlr/antlr4](https://github.com/antlr/antlr4)
  - Python Targets Setup: [https://github.com/antlr/antlr4/blob/master/doc/python-target.md](https://github.com/antlr/antlr4/blob/master/doc/python-target.md)
  - Java Targets Setup: [https://github.com/antlr/antlr4/blob/master/doc/getting-started.md](https://github.com/antlr/antlr4/blob/master/doc/getting-started.md)

### Quick-Start Guides

This section will walk you through an example about checking the equivalence of two contracts (compiled to Yul already) regarding certain self-defined transactions. The two contracts are located at `targets/yul-ast-0.7.3/tests/`, which are `B1.yul` and `Bi.yul`. Before you start, change the directory to `targets/yul-ast-0.7.3/`.

1. Run `solc` to compile the solidity souce code to Yul code (this will generate `*.yul` files):

```bash
solc ./tests/B1.sol --ir --overwrite -o ./tests/
solc ./tests/Bi.sol --ir --overwrite -o ./tests/
```

2. Parse the Yul code into s-expression in json (this will generate `*.json` files):

```bash
python ./yul_parser.py --yul ./tests/B1.yul
python ./yul_parser.py --yul ./tests/Bi.yul
```

3. Write a simple json describing the contracts to be checked and the corresponding transactions. For example, in `B-config.json` you can write:

```json
{
    "ContractPaths": [
        ["B1", "./tests/B1.json"],
        ["Bi", "./tests/Bi.json"]
    ],
    "Tasks": [
        [
            ["txn_function_call", "constructor"],
            ["txn_function_call", "foo", "uint256", "uint256"],
            ["txn_function_call", "observe"]
        ],
        [
            ["txn_function_call", "constructor"],
            ["txn_function_call", "observe"]
        ]
    ]
}
```

4. Run the equivalence checking script by:

```bash
racket ./yul-bmc.rkt --config ./configs/B-config.json
```

If the script runs correctly, you will see the following outputs:

```
task 0: #t
task 1: #f
```

which indicates the two contracts are not equal.

### The Yul Abstract Syntax Tree Parser: `yul_parser.py`

```bash
usage: yul_parser.py [-h] [--yulstr YULSTR] [--yul YUL] [--json JSON]
                     [--verbose VERBOSE]

optional arguments:
  -h, --help         show this help message and exit
  --yulstr YULSTR    input yul string
  --yul YUL          input yul file
  --json JSON        output json file
  --verbose VERBOSE  show more info for debugging
```

Note that there should not be any new lines if you switch to `--yulstr` mode, where you also need to remove the `//` comments from the Yul code, otherwise everything after the `//` will be parsed as comments.

By default, if `--yulstr` is on, the tool will output a compact stringified json; if the `--yul` is on, the tool will output the parsed json to the same path with the `*.yul` postfix replaced by `*.json`.

**<u>*Note that the tool prefers `--yulstr` than `--yul`, that is, if the two arguments are provided at the same time, the `--yul` will be ignored.*</u>**

### The Yul Bounded Model Checker: `yul-bmc.rkt`

```bash
yul-bmc [ <option> ... ]
 where <option> is one of
/ --config-str <p-str> : configuration string for bounded model checking
\ --config <p-file> : configuration file for bounded model checking
  --verbose : whether or not to show more info for debugging
  --faststop : whether or not to stop and return when the task is returning unsat
  --help, -h : Show this help
  -- : Do not treat any remaining argument as a switch (at this level)
 /|\ Brackets indicate mutually exclusive options.
 Multiple single-letter switches can be combined after one `-'; for
  example: `-h-' is the same as `-h --'
```

Note that the tool prefers `--config-str` than `--config`, that is, if both are provided, the `--config` will be ignored.

### BMC Json Configuration Format: `configs/*.json`

See `configs/B-config.json` and `configs/Bstr-config.json` for example configuration jsons. There are several top level fields:

- `ContractStrings` contains `contract name` - `contract string` paris. `contract name` is for your own reference when the verbose mode is on in the checker. `contract string` contains the flattened json string generated by the parser (e.g., `B1.json`).

- `ContractPaths` contains `contract name` - `contract path` pairs. `contract path` corresponds to the path of the json generated by the parser (e.g., `B1.json`); absolute path is preferred. **<u>*Note that the checker will prefer to read the `ContractStrings` field, that is, if `ContractStrings` and `ContractPaths` are presented, `ContractPaths` will be ignored.*</u>**
- `Tasks` contains a list of transactions. For example, in the above `B-config.json`, there are two transactions. **<u>*It's recommended that each transaction starts with a constructor call.*</u>**
- Inside every transaction, you will see a list of function calls. Specifically, every function call is of the form `["txn_function_call", <function_name>, <arg_type_0>, <arg_type_1>, ...]` where:
  - `txn_function_call` is fixed keyword,
  - `<function_name>` corresponds to function that you want to call, and
  - `<arg_type_?>` will be either "uint256" or "bool" (currently the bmc only uses these two types), which will be initialized to `(bitvector 256)` and `boolean?` symbolic types in Rosette respectively.

### Advanced Script Customizations

See `example-symbolic-1.rkt`, `example-symbolic-2.rkt` and `test.rkt` about how to further control and customize the simulator and the equivalence checking. A more detailed specifications about the yul simulator will be out soon.

### Other Notes

> quick bmc command

```bash
racket ./yul-bmc.rkt --config ./example-config.json
```

> compile Solidity to Yul

```bash
solc ./Test2T.sol --ir --overwrite -o ./
solc ./Test2T.sol --ir --overwrite -o ./
```

> antlr quick reference (java target)

```bash
antlr4 Yul.g4
javac Yul*.java
grun Yul start -tree
```

> antlr quick reference (python target)

```bash
antlr4 -Dlanguage=Python3 Yul.g4
```

> parse Yul to json

```bash
python ./yul_parser.py --yul ./tests/Test2/Symbolic1A.yul --verbose false
python ./yul_parser.py --yul ./tests/Test2/Symbolic1B.yul --verbose false
python ./yul_parser.py --yul ./tests/RandomTest/CreditDAOOriginal.yul --verbose false
```

### Major Known Issues

1. The current `zhash` has a minor issue which is fixed in the NGST-Java-Stream branch. Need to sync-up with that branch.

### Contract Adaptation Progress and Rules (from 0.6- to 0.7.2)

- contracts in `targets/yul-ast/tests/`
- from previous versions to 0.7.2
- use `solc <contract_path> --bin` to see full error message

> rules for converting older versions of code to newer (0.7.2+)

1. Make constructor function `constructor()`.
2. Make conversion between `address` and others explicit (e.g., by wrapping `address()`).
3. When calling `safedestruct(var)`, `var` should be `payable`. So do other scenarios where `payable` is required.
4. Add `public` modifiers to some functions.
5. Change function modifier `constant` to `view` or `pure`.
6. Change `throw` to `assert(false)`.
7. Specify data location to `memory`, e.g.,  `string memory solution`.
8. Replace `now` with `block.timestamp`.
9. Add `abstract` and `virtual` to some function declarations.
10. Use `address(this)` to do implicit conversion from contract to address.
11. Replace `block.blockhash()` with `blockhash()`.
12. Replace `this.balance` with `address(this).balance`.
13. Change `function ()` to fallback function `fallback ()`.
14. Add "override" specifier.
15. Make `return;` explicit by specifying what is returned.
16. For `void` functions, if there's a `return;`, change it to `return void();`.

| Contract                | Status               | Comment                                           |
| ----------------------- | -------------------- | ------------------------------------------------- |
| BdpImageStorage_1 / ..T | OK / OK              | OK / OK                                           |
| CreditDAO / ..T         | OK / OK              | OK / OK                                           |
| CryptoTask / ..T        | Failed / Not Started | Compiler error: stack too deep.                   |
| EMPresale_1 / ..T       | Failed / Not Started | Undefined identifier: ReferredPlayer              |
| EthLottery_2 / ..T      | Failed / Not Started | Wrong argument count for function call: keccak256 |
| moduleToken_1 / ..T     | Failed / Not Started | Too many to fix.                                  |
| PollManager / ..T       | Failed / Not Started | Too many to fix.                                  |

